<html>
<head>
    <title>Upload Example</title>
    <style type="text/css" media="screen">
        #progress {
            width: 500px;
            border: 1px solid black;
            position: relative;
            padding: 3px;
        }

        #percent {
            position: absolute;
            left: 50%;
        }

        #bar {
            height: 20px;
            background-color: green;
            width: 0%;
        }
    </style>
</head>
<body>

<h3>Add Project</h3>

<form id="newProjectForm"
      enctype="multipart/form-data"
      action="/project/new"
      method="post">
    <input type="text" id="pNameInput" name="name" width="100"/>
    <input id="newProjectFormSubmit" type="submit" value="Add"/>
</form>

<br><br><br><br><br><br>
<hr>
<h3>Add Release</h3>
<select id="projects">
    <option value="" disabled selected>Select project</option>
</select>

<div>
    Release: <input type="text" width="100" id="release"/> (<em>previous release was: <span id="latest_release"></span></em>)
</div>

<form id="uploadForm"
      enctype="multipart/form-data"
      action="/api/upload"
      method="post">
    <input type="file" id="userFileInput" name="userFile"/>
</form>
<span id="status"></span>

<div id="progress">
    <span id="percent">0%</span>

    <div id="bar"></div>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="./js/upload.js"></script>

<script>
    $(function () {
        var refreshProjectsList = function () {
            $.get('/project/all', function (data) {
                if (data) {
                    var projects = data.projects;
                    $('#projects')
                            .find('option[value!=""]')
                            .remove();
                    projects.forEach(function (p) {

                        $('#projects')
                                .append($("<option></option>")
                                        .attr("value", p._id)
                                        .text(p._id));
                    });
                }
            });
        };
        refreshProjectsList();

        $('#projects').change(function () {
            $.get('/project/one/' + $('#projects').val(), function (data) {
                if (data.success) {
                    var project = data.project;
                    $('#latest_release').text(project.latest || '');
                }
            });
        });

        $('input#newProjectFormSubmit').click(function () {
            var projectName = $('#pNameInput').val();
            if (!projectName) {
                alert('Please provide a project name.');
                return false;
            }
            $.ajax({ type: 'POST', url: '/project/new', data: JSON.stringify({ name: projectName }),
                        success: function (data) {
                            refreshProjectsList();
                            alert(projectName + ' added successfully.');
                        },
                        error: function (data) {
                            alert(data.responseJSON.error);
                        },
                        contentType: 'application/json' }
            );
            return false;
        });

//        $('#newProjectForm').submit(function () {
//
//            var projectName = $('#pNameInput').val();
//            if (!projectName) {
//                alert('Please provide a project name.');
//                return false;
//            }
//
//            var formData = new FormData();
//            formData.append('name', file);
//            var xhr = new XMLHttpRequest();
//            xhr.overrideMimeType('application/json');
//            xhr.open('post', '/project/' + project +'/up/' + release, true);
//            xhr.upload.onprogress = function (e) {
//                if (e.lengthComputable)
//                    setProgress(Math.round((e.loaded / e.total) * 100));
//            };
//            xhr.onerror = function (e) {
//                status('error while trying to upload');
//            };
//            xhr.onload = function () {
//                $('#userFileInput').val('');
//                setProgress(0);
//                var resJson = JSON.parse(xhr.responseText);
//                status(resJson.file + ' done, choose a file');
//                setTimer();
//                if (resJson.image)
//                    window.open('./uploads/' + resJson.savedAs, 'upload', 'status=1, height = 300, width = 300, resizable = 0');
//                else
//                    console.log('not an image');
//            };
//            xhr.send(formData);
//            return false; // no refresh
//        });
    });
</script>

</body>
</html>